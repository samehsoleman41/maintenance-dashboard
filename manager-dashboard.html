<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مصر تكنولوجى — لوحة المدير</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

  <style>
    :root { --primary:#f97316; --bg:#faf8f5; --card:#fff; --text:#111 }
    body { font-family:'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text) }
    .navbar { background:var(--primary)!important }
    .btn-primary { background:var(--primary); border-color:var(--primary) }
    .btn-primary:hover { filter:brightness(.95) }
    .card { border:none; border-radius:1rem; box-shadow:0 6px 18px rgba(0,0,0,.06) }
    .kpi { color:#fff; border-radius:1rem }
    .pill{ border-radius:999px; font-size:.75rem; padding:.25rem .6rem; display:inline-block }
    .pill-new{ background:#fff4ea; color:var(--primary) }
    .pill-inp{ background:#eaf6ff; color:#0ea5e9 }
    .pill-done{ background:#eafaf0; color:#16a34a }
    .pill-cancel{ background:#eee; color:#555 }
    .form-control,.form-select{ border-radius:.8rem }
    .offcanvas{ width:min(560px, 100vw) }
    .cursor-pointer{ cursor:pointer }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f97316">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="fa-solid fa-screwdriver-wrench me-2"></i><span id="brandName">مصر تكنولوجى</span>
      </a>
      <div class="d-flex gap-2">
        <button class="btn btn-light" id="btnImportCustomers">
          <i class="fa-solid fa-file-excel me-1"></i> استيراد عملاء
        </button>
        <input id="xlsCustomers" type="file" accept=".xlsx,.xls,.csv" hidden>
        <button class="btn btn-light" onclick="window.print()">
          <i class="fa-solid fa-print me-1"></i> طباعة
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- شريط أدوات أعلى الجدول -->
    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-4">
        <label class="form-label">بحث</label>
        <input id="q" class="form-control" placeholder="ابحث باسم العميل / رقم التذكرة / نوع الجهاز / ملاحظات" />
      </div>
      <div class="col-md-2">
        <label class="form-label">المهندس</label>
        <select id="fltTech" class="form-select"></select>
      </div>
      <div class="col-md-2">
        <label class="form-label">الحالة</label>
        <select id="fltStatus" class="form-select">
          <option value="">كل الحالات</option>
          <option value="new">new</option>
          <option value="in_progress">in_progress</option>
          <option value="done">done</option>
          <option value="cancelled">cancelled</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">من</label>
        <input id="from" type="date" class="form-control" />
      </div>
      <div class="col-md-2">
        <label class="form-label">إلى</label>
        <input id="to" type="date" class="form-control" />
      </div>
    </div>

    <div class="d-flex gap-2 mb-3">
      <button id="btnSearch" class="btn btn-primary"><i class="fa-solid fa-filter me-1"></i> بحث</button>
      <button id="btnReset" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate-left me-1"></i> مسح</button>

      <div class="ms-auto d-flex gap-2">
        <button id="btnExportCSV" class="btn btn-success"><i class="fa-solid fa-file-csv me-1"></i> CSV</button>
        <button id="btnExportXLSX" class="btn btn-success"><i class="fa-solid fa-file-excel me-1"></i> Excel</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mdlNew">
          <i class="fa-solid fa-plus me-1"></i> تذكرة جديدة
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:var(--primary)"><div class="small opacity-75">إجمالي التذاكر</div><div class="h4 m-0" id="kpiTotal">0</div></div></div>
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:#0ea5e9"><div class="small opacity-75">قيد التنفيذ</div><div class="h4 m-0" id="kpiInProg">0</div></div></div>
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:#22c55e"><div class="small opacity-75">مكتملة</div><div class="h4 m-0" id="kpiDone">0</div></div></div>
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:#a78bfa"><div class="small opacity-75">إيراد الشهر</div><div class="h4 m-0" id="kpiRevenue">0</div></div></div>
    </div>

    <!-- جدول التذاكر -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="m-0">التذاكر</h5>
          <div>
            <span class="pill pill-new">جديد</span>
            <span class="pill pill-inp ms-1">قيد التنفيذ</span>
            <span class="pill pill-done ms-1">مكتمل</span>
            <span class="pill pill-cancel ms-1">ملغي</span>
          </div>
        </div>
        <div class="table-responsive">
          <table id="tbl" class="table table-striped align-middle" style="width:100%">
            <thead><tr>
              <th>رقم</th><th>العميل</th><th>الهاتف</th><th>المهندس</th><th>الحالة</th><th>تاريخ الفتح</th>
              <th>العربون</th><th>الإجمالي</th><th>صور</th><th>إسناد</th><th>إجراءات</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- مودال إنشاء تذكرة -->
  <div class="modal fade" id="mdlNew" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">إنشاء تذكرة</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-4"><label class="form-label">اسم العميل</label><input id="n_customer" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">الهاتف</label><input id="n_phone" class="form-control" placeholder="01xxxxxxxxx"></div>
            <div class="col-md-4"><label class="form-label">العنوان</label><input id="n_address" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">نوع الجهاز</label><input id="n_device" class="form-control"></div>
            <div class="col-md-8"><label class="form-label">وصف المشكلة</label><input id="n_problem" class="form-control"></div>
            <div class="col-md-6">
              <label class="form-label">المهندس</label>
              <select id="n_engineer" class="form-select"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">الحالة</label>
              <select id="n_status" class="form-select">
                <option value="new">new</option>
                <option value="in_progress">in_progress</option>
                <option value="done">done</option>
                <option value="cancelled">cancelled</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button id="btnCreate" class="btn btn-primary">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas تفاصيل/تعديل -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="sheetTicket">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">تفاصيل التذكرة <span id="t_id" class="text-muted"></span></h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="small text-muted mb-2" id="t_status"></div>
      <div class="mb-3">
        <label class="form-label">ملاحظات الطلب</label>
        <textarea id="t_order_notes" class="form-control" rows="3" placeholder="ملاحظات للعميل أو الإدارة"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">ملاحظات المهندس</label>
        <textarea id="t_engineer_notes" class="form-control" rows="3" placeholder="يملؤها المهندس من طريقته"></textarea>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">العربون</label>
          <input id="t_deposit" type="number" class="form-control" min="0">
        </div>
        <div class="col-6">
          <label class="form-label">الإجمالي</label>
          <input id="t_total" type="number" class="form-control" min="0">
        </div>
        <div class="col-12">
          <label class="form-label">موعد التسليم (اختياري)</label>
          <input id="t_due" type="datetime-local" class="form-control">
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button id="btnSaveTicket" class="btn btn-primary"><i class="fa-solid fa-floppy-disk me-1"></i> حفظ</button>
        <button id="btnMarkDone" class="btn btn-success"><i class="fa-solid fa-circle-check me-1"></i> إغلاق كتامة</button>
      </div>
      <hr>
      <div id="t_images" class="d-flex flex-wrap gap-2"></div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // PWA
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }

    // ============ تحميل الإعدادات من config.json + دعم ?key= =============
    window.APP_CONFIG = {
      API_BASE: '',              // مثال: https://script.google.com/macros/s/XXXX/exec
      API_KEY: '',               // يُمكن تمريره مرة عبر ?key=XXXX وسيُخزن محليًا
      DEFAULT_COUNTRY_CODE: '20',
      COMPANY_NAME: 'لوحة إدارة الصيانة',
      PRIMARY_COLOR: '#f97316',
      FONT_FAMILY: 'Tajawal',
      POLICIES: { REQUIRE_ADDRESS_DETAIL:true, REQUIRE_NOTES:true, REQUIRE_PHOTO:false, NOTIFY_WA:true, NOTIFY_TG:false }
    };

    (function(){
      const qs = new URLSearchParams(location.search);
      const key = qs.get('key'); if (key) localStorage.setItem('API_KEY', key);

      fetch('./config.json', {cache:'no-store'})
        .then(r => r.ok ? r.json() : {})
        .catch(()=>({}))
        .then(cfg => {
          Object.assign(window.APP_CONFIG, cfg||{});
          if (!window.APP_CONFIG.API_KEY) window.APP_CONFIG.API_KEY = localStorage.getItem('API_KEY') || '';

          // ثيم
          if (window.APP_CONFIG.PRIMARY_COLOR) document.documentElement.style.setProperty('--primary', window.APP_CONFIG.PRIMARY_COLOR);
          if (window.APP_CONFIG.FONT_FAMILY) document.body.style.fontFamily = window.APP_CONFIG.FONT_FAMILY + ', system-ui, -apple-system, Segoe UI, Roboto, Arial';
          const b = document.getElementById('brandName'); if (b && window.APP_CONFIG.COMPANY_NAME) b.textContent = window.APP_CONFIG.COMPANY_NAME;

          if (typeof window.__app_boot === 'function') window.__app_boot();
        });
    })();

    // ================= Helpers & API =================
    const $ = s => document.querySelector(s);
    const statusPill = s => s==='in_progress' ? '<span class="pill pill-inp">قيد التنفيذ</span>' :
                          (s==='done' ? '<span class="pill pill-done">مكتمل</span>' :
                          (s==='cancelled' ? '<span class="pill pill-cancel">ملغي</span>' : '<span class="pill pill-new">جديد</span>'));

    async function apiGET(url){ const r=await fetch(url); const j=await r.json(); if(!j.ok) throw new Error(j.error||'API error'); return j; }
    async function apiPOST(body){
      const r=await fetch(APP_CONFIG.API_BASE, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(Object.assign({key:APP_CONFIG.API_KEY}, body))
      });
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'API error'); return j;
    }

    let ALL = [], TECHS = []; let dt;

    async function fetchTickets(){
      const j = await apiGET(`${APP_CONFIG.API_BASE}?fn=listAll&key=${encodeURIComponent(APP_CONFIG.API_KEY)}`);
      return (j.data||[]).map(t=>({
        id:t.ticket_id,
        customer:t.customer_name,
        phone:t.phone||'',
        tech:t.assigned_to||'',
        status:t.status||'new',
        date:t.opened_at||'',
        dep:+(t.deposit||0),
        tot:+(t.total||0),
        notes:t.order_notes||'',
        images:(t.device_images||''),
        raw:t
      }));
    }
    async function fetchTechs(){
      const j = await apiGET(`${APP_CONFIG.API_BASE}?fn=listTechs&key=${encodeURIComponent(APP_CONFIG.API_KEY)}`);
      return (j.data||[]);
    }
    async function assignTicket(payload){ return apiPOST({ fn:'assignTicket', payload }); }
    async function updateTicket(payload){ return apiPOST({ fn:'updateTicket', payload }); }
    async function addTicket(payload){ return apiPOST({ fn:'addTicket', payload }); }
    async function upsertCustomersBulk(rows){ return apiPOST({ fn:'upsertCustomersBulk', payload:{ rows } }); }

    function fillTechFilters(){
      const sel=$('#fltTech'); sel.innerHTML=''; sel.insertAdjacentHTML('beforeend','<option value="">كل المهندسين</option>');
      TECHS.forEach(x=> sel.insertAdjacentHTML('beforeend',`<option value="${x.name}">${x.name}</option>`));
    }

    function refreshTable(rows){
      if(dt){ dt.destroy(); $('#tbl tbody').innerHTML=''; }
      const tb = $('#tbl tbody'); tb.innerHTML='';
      rows.forEach(r=>{
        const imgs=(r.images||'').split('\n').filter(Boolean);
        const photos = imgs.length?`<a href="${imgs[0]}" target="_blank">${imgs.length} صورة</a>`:'—';
        const ageDays = r.date ? Math.floor((Date.now()-new Date(r.date).getTime())/86400000) : 0;
        const overdue = (r.status!=='done' && ageDays>=3) ? '<span class="badge bg-danger ms-1">متأخرة</span>' : '';
        tb.insertAdjacentHTML('beforeend',`<tr class="cursor-pointer" data-id="${r.id}">
          <td>${r.id}</td>
          <td>${r.customer||''} ${overdue}</td>
          <td>${r.phone?`<a href="tel:${r.phone}">${r.phone}</a>`:'—'}</td>
          <td>${r.tech||''}</td>
          <td>${statusPill(r.status)}</td>
          <td>${r.date? new Date(r.date).toLocaleString('ar-EG'):''}</td>
          <td>${r.dep||0}</td>
          <td>${r.tot||0}</td>
          <td>${photos}</td>
          <td><button class="btn btn-sm btn-outline-primary" data-assign="${r.id}">إسناد</button></td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-secondary" data-copylink>نسخ رابط</button>
            ${r.phone?`<a class="btn btn-sm btn-outline-success" target="_blank" href="https://wa.me/${APP_CONFIG.DEFAULT_COUNTRY_CODE}${r.phone.replace(/\D/g,'')}">واتساب</a>`:''}
          </td>
        </tr>`);
      });
      dt = new DataTable('#tbl', { language:{ url:'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json' }, pageLength:10 });

      // صف أحداث الجدول (فتح الشِيت الجانبي + إسناد + نسخ رابط)
      tb.querySelectorAll('tr').forEach(tr=>{
        tr.addEventListener('click', e=>{
          const id = tr.getAttribute('data-id');
          if(!id) return; // الأزرار المخصصة لها handlers أدناه
          const isButton = e.target.closest('button');
          if(isButton) return;
          openTicketSheet(id);
        });
      });
      tb.querySelectorAll('[data-assign]').forEach(btn=> btn.addEventListener('click', e=>{
        e.stopPropagation();
        openAssign(btn.getAttribute('data-assign'));
      }));
      tb.querySelectorAll('[data-copylink]').forEach(btn=> btn.addEventListener('click', e=>{
        e.stopPropagation();
        navigator.clipboard.writeText(location.href.split('#')[0]);
      }));

      // KPIs
      $('#kpiTotal').textContent = rows.length;
      $('#kpiInProg').textContent = rows.filter(t=>t.status==='in_progress').length;
      $('#kpiDone').textContent   = rows.filter(t=>t.status==='done').length;
      const now = new Date();
      const y = now.getFullYear(), m = (now.getMonth()+1).toString().padStart(2,'0');
      const month = `${y}-${m}`;
      const rev = rows.filter(t=> (t.date||'').toString().startsWith(month)).reduce((a,b)=> a + (Number(b.tot)||0), 0);
      $('#kpiRevenue').textContent = rev.toLocaleString('ar-EG') + ' ج';
    }

    function applyFilters(){
      const q=($('#q').value||'').toLowerCase(); const te=$('#fltTech').value; const st=$('#fltStatus').value; const f=$('#from').value; const t=$('#to').value;
      const rows = ALL.filter(r=>{
        let ok=true;
        if(q) ok = ok && (`${r.id} ${r.customer} ${r.tech} ${r.notes}`.toLowerCase().includes(q));
        if(te) ok = ok && r.tech===te;
        if(st) ok = ok && r.status===st;
        if(f) ok = ok && new Date(r.date)>=new Date(f);
        if(t) ok = ok && new Date(r.date)<=new Date(t+'T23:59:59');
        return ok;
      });
      refreshTable(rows);
    }

    async function openAssign(id){
      const engineer = await pickEngineer();
      if(!engineer) return;
      const phone = prompt('هاتف العميل (اختياري)?','');
      const summary = prompt('ملخص قصير للتذكرة/الموعد؟','');
      try{
        await assignTicket({ ticket_id:id, engineer, phone, summary, customer_name: (ALL.find(x=>x.id===id)?.customer)||'' });
        alert('تم الإسناد (وسيُرسل الإشعار من السكربت إذا كان مفعّل).');
        await reloadAll();
      }catch(e){ alert('تعذّر الإسناد: '+e.message); }
    }

    function pickEngineer(){
      return new Promise(resolve=>{
        const names = TECHS.map(t=>t.name).filter(Boolean);
        if(!names.length){ alert('لا يوجد مهندسون — أضف مهندسًا أولًا.'); return resolve(''); }
        const name = prompt('اسم المهندس المكلّف؟ (اختر من القائمة):\n' + names.join(', '));
        resolve(name||'');
      });
    }

    // ======= استيراد العملاء من ملف =======
    $('#btnImportCustomers').addEventListener('click', ()=> $('#xlsCustomers').click());
    $('#xlsCustomers').addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0]; if(!f) return;
      const ab = await f.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      // نتوقع أعمدة: name, phone, address (حروف صغيرة)
      const clean = rows.map(r=>({
        name: (r.name||r['اسم']||'').toString().trim(),
        phone: (r.phone||r['هاتف']||'').toString().trim(),
        address: (r.address||r['عنوان']||'').toString().trim()
      })).filter(x=> x.phone);
      if(!clean.length) return alert('لم يتم العثور على صفوف صالحة. تأكد من الأعمدة: name, phone, address');
      try{
        await upsertCustomersBulk(clean);
        alert('تم استيراد/تحديث العملاء: '+clean.length);
      }catch(e){ alert('فشل الاستيراد: '+e.message); }
      ev.target.value='';
    });

    // ======= فتح شيت التفاصيل الجانبي =======
    let currentTicket = null;
    const offEl = document.getElementById('sheetTicket');
    const off = new bootstrap.Offcanvas(offEl);

    function openTicketSheet(id){
      const t = ALL.find(x=> x.id===id); if(!t) return;
      currentTicket = t;
      $('#t_id').textContent = '#'+t.id;
      $('#t_status').innerHTML = statusPill(t.status);
      $('#t_order_notes').value = t.raw.order_notes||'';
      $('#t_engineer_notes').value = t.raw.engineer_notes||'';
      $('#t_deposit').value = t.dep||0;
      $('#t_total').value = t.tot||0;
      $('#t_due').value = t.raw.due_at ? fmtLocalInputDate(new Date(t.raw.due_at)) : '';
      // صور
      const wrap = document.getElementById('t_images'); wrap.innerHTML='';
      (t.images||'').split('\n').filter(Boolean).forEach(u=>{
        const a = document.createElement('a'); a.href=u; a.target='_blank';
        const img=document.createElement('img'); img.src=u; img.style.width='96px'; img.style.height='96px'; img.style.objectFit='cover'; img.className='rounded';
        a.appendChild(img); wrap.appendChild(a);
      });
      off.show();
    }

    function fmtLocalInputDate(d){
      const pad=n=>n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    document.getElementById('btnSaveTicket').addEventListener('click', async ()=>{
      if(!currentTicket) return;
      try{
        await updateTicket({
          ticket_id: currentTicket.id,
          order_notes: $('#t_order_notes').value,
          engineer_notes: $('#t_engineer_notes').value,
          deposit: Number($('#t_deposit').value||0),
          total: Number($('#t_total').value||0),
          due_at: $('#t_due').value || null
        });
        alert('تم الحفظ');
        off.hide();
        await reloadAll();
      }catch(e){ alert('تعذر الحفظ: '+e.message); }
    });
    document.getElementById('btnMarkDone').addEventListener('click', async ()=>{
      if(!currentTicket) return;
      if(!confirm('إغلاق التذكرة؟')) return;
      try{
        await updateTicket({ ticket_id: currentTicket.id, markDone:true });
        alert('تم الإغلاق');
        off.hide();
        await reloadAll();
      }catch(e){ alert('تعذر الإغلاق: '+e.message); }
    });

    // ======= Export =======
    function exportCSV(rows){
      const header=['id','customer','phone','tech','status','date','dep','tot','notes'];
      const csv=[header.join(',')].concat(rows.map(r=> header.map(h=> JSON.stringify(r[h]??'')).join(','))).join('\n');
      const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tickets.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function exportXLSX(rows){ const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Tickets'); XLSX.writeFile(wb, 'tickets.xlsx'); }
    document.getElementById('btnExportCSV').onclick = ()=> exportCSV(ALL);
    document.getElementById('btnExportXLSX').onclick = ()=> exportXLSX(ALL);

    // ======= إنشاء التذكرة =======
    document.getElementById('btnCreate').addEventListener('click', async ()=>{
      const data = {
        // backend لديه api_addTicket_ الذي ينشئ id إذا لم يُرسل — نرسل فراغ
        customer_name: document.getElementById('n_customer').value.trim(),
        phone: document.getElementById('n_phone').value.trim(),
        address: document.getElementById('n_address').value.trim(),
        device_type: document.getElementById('n_device').value.trim(),
        problem_desc: document.getElementById('n_problem').value.trim(),
        status: document.getElementById('n_status').value,
        assigned_to: document.getElementById('n_engineer').value
      };
      if (!data.customer_name) return alert('أدخل اسم العميل');
      try{
        await addTicket(data);
        alert('تم إنشاء التذكرة');
        bootstrap.Modal.getInstance(document.getElementById('mdlNew')).hide();
        await reloadAll();
      }catch(e){ alert('تعذّر الإنشاء: '+e.message); }
    });

    // Boot
    async function __app_boot(){
      if (!APP_CONFIG.API_BASE) return alert('⚠️ ضع API_BASE في config.json');
      if (!APP_CONFIG.API_KEY)  console.warn('ℹ️ يمكنك تمرير ?key=YOUR_API_KEY مرة واحدة وسيُخزن محليًا.');
      await reloadAll();
      $('#btnSearch').addEventListener('click', applyFilters);
      $('#btnReset').addEventListener('click', async ()=>{ $('#q').value=''; $('#fltTech').value=''; $('#fltStatus').value=''; $('#from').value=''; $('#to').value=''; await reloadAll(); });
    }

    async function reloadAll(){
      ALL = await fetchTickets();
      try { TECHS = await fetchTechs(); } catch(e) { TECHS=[]; }
      // تعبئة اختيار المهندسين في نموذج الإضافة
      const sel = document.getElementById('n_engineer');
      if (sel) sel.innerHTML = '<option value="">— بدون —</option>' + TECHS.map(t=>`<option>${t.name}</option>`).join('');
      fillTechFilters();
      refreshTable(ALL);
    }

    // اجعل الدالة متاحة بعد تحميل config
    window.__app_boot = __app_boot;
  </script>
</body>
</html>
<div class="card mt-4">
  <div class="card-body">
    <h5 class="mb-3"><i class="fa-solid fa-gear me-1"></i> الإعدادات</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">API Base URL</label>
        <input id="cfg_api_base" class="form-control" placeholder="https://script.google.com/macros/s/.../exec" />
      </div>
      <div class="col-md-6">
        <label class="form-label">API Key</label>
        <input id="cfg_api_key" class="form-control" placeholder="مثال: f642937d-fb1" />
      </div>
      <div class="col-md-6">
        <label class="form-label">اسم الشركة</label>
        <input id="cfg_company_name" class="form-control" placeholder="مثال: مصر تكنولوجى" />
      </div>
      <div class="col-md-6">
        <label class="form-label">اللون الرئيسي</label>
        <input id="cfg_color" type="color" class="form-control form-control-color" />
      </div>
      <div class="col-md-12 text-end">
        <button id="btnSaveSettings" class="btn btn-primary">
          <i class="fa-solid fa-save me-1"></i> حفظ الإعدادات
        </button>
      </div>
    </div>
  </div>
</div>
function loadSettings() {
  $('#cfg_api_base').value = localStorage.getItem('API_BASE') || APP_CONFIG.API_BASE;
  $('#cfg_api_key').value  = localStorage.getItem('API_KEY') || APP_CONFIG.API_KEY;
  $('#cfg_company_name').value = localStorage.getItem('COMPANY_NAME') || APP_CONFIG.COMPANY_NAME;
  $('#cfg_color').value = localStorage.getItem('PRIMARY_COLOR') || APP_CONFIG.PRIMARY_COLOR;
}

$('#btnSaveSettings').addEventListener('click', () => {
  localStorage.setItem('API_BASE', $('#cfg_api_base').value);
  localStorage.setItem('API_KEY', $('#cfg_api_key').value);
  localStorage.setItem('COMPANY_NAME', $('#cfg_company_name').value);
  localStorage.setItem('PRIMARY_COLOR', $('#cfg_color').value);
  alert('تم حفظ الإعدادات بنجاح. أعد تحميل الصفحة لتطبيقها.');
});

document.addEventListener('DOMContentLoaded', loadSettings);
