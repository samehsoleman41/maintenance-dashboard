/**************************************************************
 * Maintenance Tickets Backend (Google Apps Script Web App)
 * Sheets: Tickets, Technicians, PulledParts, Logs, Settings, Customers
 * Features:
 *  - REST endpoints للمدير/المهندس
 *  - صور على Drive (Anyone with link)
 *  - إشعارات واتساب/تلغرام (debounced)
 *  - إعدادات مركزية + سياسات إلزام
 *  - إضافة/استيراد عملاء + تمييز جديد/قديم
 *  - تعيين تذاكر + روابط مباشرة
 *  - Overdue cron + Backup XLSX
 **************************************************************/
/******** ONE-TIME HEADER FIX ********/
/**************** ONE-TIME MIGRATION: Fix/Normalize Headers ****************/
// 1) لو سكربت Standalone؛ خلي الشيت يتحدد بالـ SS_ID في Script Properties
function getSS_(){
  const sp = PropertiesService.getScriptProperties();
  const id = sp.getProperty('SS_ID');
  if (id) { try { return SpreadsheetApp.openById(id); } catch(e){} }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  if (!ss) throw new Error('لم يتم تحديد ملف الشيت. ضع SS_ID في Script Properties أو افتح السكربت من داخل الشيت ثم أعد المحاولة.');
  sp.setProperty('SS_ID', ss.getId());
  return ss;
}
function SH_(name){ const ss=getSS_(); return ss.getSheetByName(name) || ss.insertSheet(name); }

// 2) الهيدر القياسي (يجب أن يطابق CFG.TICKETS_HEADER المستخدم في كودك)
const TICKETS_HEADER_STANDARD = [
  'ticket_id','customer_id','customer_name','phone','address','device_type','problem_desc',
  'status','assigned_to','assigned_to_id','opened_at','closed_at','deposit','total',
  'address_detail','order_notes','engineer_notes','pulled_parts','device_images','due_at','last_update'
];

// 3) خريطة ترجمة أسماء الأعمدة الشائعة (AR → EN)
const TICKETS_HEADER_MAP = {
  // أساسي
  'معرف التذكرة':'ticket_id','رقم التذكرة':'ticket_id','id':'ticket_id',
  'customer_id':'customer_id','معرف العميل':'customer_id',
  'customer_name':'customer_name','اسم العميل':'customer_name','العميل':'customer_name',
  'phone':'phone','الهاتف':'phone','تليفون':'phone','رقم الهاتف':'phone',
  'address':'address','العنوان':'address',
  'device_type':'device_type','نوع الجهاز':'device_type','الجهاز':'device_type',
  'problem_desc':'problem_desc','وصف المشكلة':'problem_desc','المشكلة':'problem_desc',
  'status':'status','الحالة':'status',
  'assigned_to':'assigned_to','المهندس':'assigned_to',
  'assigned_to_id':'assigned_to_id','معرف المهندس':'assigned_to_id',

  'opened_at':'opened_at','تاريخ الفتح':'opened_at','فتح بتاريخ':'opened_at',
  'closed_at':'closed_at','تاريخ الإغلاق':'closed_at','اغلاق بتاريخ':'closed_at',

  'deposit':'deposit','العربون':'deposit',
  'total':'total','الإجمالي':'total',

  'address_detail':'address_detail','العنوان التفصيلي':'address_detail',
  'order_notes':'order_notes','ملاحظات الطلب':'order_notes','ملاحظات':'order_notes',
  'engineer_notes':'engineer_notes','ملاحظات المهندس':'engineer_notes',
  'pulled_parts':'pulled_parts','قطع مسحوبة':'pulled_parts',
  'device_images':'device_images','صور الجهاز':'device_images','الصور':'device_images',
  'due_at':'due_at','تاريخ الاستحقاق':'due_at',
  'last_update':'last_update','آخر تحديث':'last_update'
};

// 4) تطبيع هيدر ورقة Tickets: يعيد تسمية الأعمدة العربية → الإنجليزية ويضيف الناقص
function normalizeTicketsHeaders_(){
  const sh = SH_('Tickets');
  if (sh.getLastRow() === 0) sh.appendRow(TICKETS_HEADER_STANDARD); // لو فاضية تمامًا
  const lastCol = Math.max(1, sh.getLastColumn());
  const hdr = sh.getRange(1,1,1,lastCol).getValues()[0];

  // أ. إعادة تسمية الأعمدة حسب الخريطة
  const newHdr = hdr.map(h => {
    const key = String(h || '').trim();
    if (!key) return '';
    // جرّب تطبيع مباشر أو Lower-case للمفاتيح الإنجليزية
    const mapped = TICKETS_HEADER_MAP[key] || TICKETS_HEADER_MAP[key.toLowerCase()] || key;
    return mapped;
  });

  // ب. اكتب أسماء الأعمدة المطبوعة
  sh.getRange(1,1,1,newHdr.length).setValues([newHdr]);

  // ج. أضف أي أعمدة قياسية ناقصة في نهاية الهيدر (مع حفظ البيانات القائمة كما هي)
  const have = new Set(newHdr.filter(Boolean));
  const missing = TICKETS_HEADER_STANDARD.filter(k => !have.has(k));
  if (missing.length){
    const start = sh.getLastColumn()+1;
    missing.forEach((name, i)=>{
      // إنشاء عمود جديد ووضع اسمه في الصف الأول
      const col = start + i;
      // نضمن وجود هذا العمود فعليًا
      if (col > sh.getMaxColumns()) sh.insertColumnAfter(sh.getLastColumn());
      sh.getRange(1, col, 1, 1).setValue(name);
    });
  }
  SpreadsheetApp.flush();
  return { ok:true, message:'Tickets header normalized', header: readHeader_(sh) };
}

// 5) تطبيع هيدر ورقة Technicians
function normalizeTechsHeaders_(){
  const sh = SH_('Technicians');
  const want = ['tech_id','name','phone'];
  if (sh.getLastRow() === 0) { sh.appendRow(want); return { ok:true, header:want }; }

  const lastCol = Math.max(1, sh.getLastColumn());
  const hdr = sh.getRange(1,1,1,lastCol).getValues()[0].map(x=>String(x||'').trim());

  const map = { 'معرف المهندس':'tech_id','id':'tech_id','الاسم':'name','الهاتف':'phone','تليفون':'phone' };
  const newHdr = hdr.map(h => map[h] || map[h.toLowerCase?.()] || h);
  sh.getRange(1,1,1,newHdr.length).setValues([newHdr]);

  // أضف الناقص
  const have = new Set(newHdr.filter(Boolean));
  const missing = want.filter(k=> !have.has(k));
  if (missing.length){
    const start = sh.getLastColumn()+1;
    missing.forEach((name, i)=>{
      const col = start + i;
      if (col > sh.getMaxColumns()) sh.insertColumnAfter(sh.getLastColumn());
      sh.getRange(1, col, 1, 1).setValue(name);
    });
  }
  SpreadsheetApp.flush();
  return { ok:true, header: readHeader_(sh) };
}

// 6) هيلبرز القراءة (تستخدمها الدوال أعلاه)
function readHeader_(sh){ return sh.getRange(1,1,1,Math.max(1, sh.getLastColumn())).getValues()[0]; }

// 7) دالة “كل-in-one”: شغّلها مرة واحدة
function fixAllHeaders(){
  const out = {};
  out.tickets = normalizeTicketsHeaders_();
  out.techs   = normalizeTechsHeaders_();

  // باقي الشيتات الأساسية (لو ناقصة فقط)
  const ensure = (name, hdr)=>{
    const sh = SH_(name);
    if (sh.getLastRow() === 0) sh.appendRow(hdr);
  };
  ensure('PulledParts', ['id','ticket_id','customer_name','tech_id','tech_name','part_name','qty','photo_file_id']);
  ensure('Logs',        ['ts','actor','action','ticket_id','engineer','customer','details']);
  ensure('Settings',    ['key','value']);
  ensure('Customers',   ['customer_id','name','phone','address','first_seen','last_seen','tickets_count']);

  return out;
}

function fixAllHeaders(){
  const ss = (typeof getSS_ === 'function') ? getSS_() : SpreadsheetApp.getActiveSpreadsheet();
  if (!ss) throw new Error('No spreadsheet. افتح السكربت من داخل الشيت أو استخدم getSS_ + SS_ID.');

  // 1) Tickets
  const shT = ss.getSheetByName('Tickets') || ss.insertSheet('Tickets');
  shT.getRange(1,1,1, CFG.TICKETS_HEADER.length).setValues([CFG.TICKETS_HEADER]);

  // 2) Technicians
  const shX = ss.getSheetByName('Technicians') || ss.insertSheet('Technicians');
  const techHdr = ['tech_id','name','phone'];
  shX.getRange(1,1,1, techHdr.length).setValues([techHdr]);

  // 3) باقي الشيتات الأساسية لو ناقصة
  const ensure = (name, hdr)=> {
    const sh = ss.getSheetByName(name) || ss.insertSheet(name);
    sh.getRange(1,1,1,hdr.length).setValues([hdr]);
  };
  ensure('PulledParts', ['id','ticket_id','customer_name','tech_id','tech_name','part_name','qty','photo_file_id']);
  ensure('Logs',       ['ts','actor','action','ticket_id','engineer','customer','details']);
  ensure('Settings',   ['key','value']);
  ensure('Customers',  ['customer_id','name','phone','address','first_seen','last_seen','tickets_count']);

  SpreadsheetApp.flush();
  return 'Headers fixed ✅';
}

const CFG = {
  SHEETS: {
    TICKETS: 'Tickets',
    TECHS: 'Technicians',
    PARTS: 'PulledParts',
    LOGS: 'Logs',
    SETTINGS: 'Settings',
    CUSTOMERS: 'Customers'
  },
  PHOTOS_FOLDER: 'Service_Photos',
  BACKUP_FOLDER: 'Backups',
  TZ: 'Africa/Cairo',

  TICKETS_HEADER: [
    'ticket_id','customer_id','customer_name','phone','address','device_type','problem_desc',
    'status','assigned_to','assigned_to_id','opened_at','closed_at','deposit','total',
    'address_detail','order_notes','engineer_notes','pulled_parts','device_images','due_at','last_update'
  ],
  TECHS_HEADER: ['tech_id','name','phone'],
  PARTS_HEADER: ['id','ticket_id','customer_name','tech_id','tech_name','part_name','qty','photo_file_id'],
  LOGS_HEADER:  ['ts','actor','action','ticket_id','engineer','customer','details'],
  SETTINGS_HEADER: ['key','value'],
  CUSTOMERS_HEADER: ['customer_id','name','phone','address','first_seen','last_seen','tickets_count'],

  DEFAULT_SETTINGS: {
    COMPANY_NAME: 'لوحة إدارة الصيانة',
    SUPPORT_PHONE: '',
    SUPPORT_ADDR: '',
    PRIMARY_COLOR: '#f97316',
    FONT_FAMILY: 'Tajawal',
    REQUIRE_ADDRESS_DETAIL: 'true',
    REQUIRE_NOTES: 'true',
    REQUIRE_PHOTO: 'false',
    NOTIFY_WA: 'true',
    NOTIFY_TG: 'false'
  }
};

/**************************** SECURITY ****************************/
function getApiKey_(){
  return PropertiesService.getScriptProperties().getProperty('API_KEY') || '';
}
function requireApiKey_(e){
  const k = (e?.parameter?.key)
         || (e?.postData && JSON.parse(e.postData.contents || '{}')?.key)
         || '';
  if (!k || k !== getApiKey_()) throw new Error('Unauthorized: bad or missing API key');
}

/******************* INIT *******************/
function setupAll(){
  const ss = SpreadsheetApp.getActive();

  const shT = SH_(CFG.SHEETS.TICKETS);       if (shT.getLastRow()===0) shT.appendRow(CFG.TICKETS_HEADER);
  const shX = SH_(CFG.SHEETS.TECHS);         if (shX.getLastRow()===0) shX.appendRow(CFG.TECHS_HEADER);
  const shP = SH_(CFG.SHEETS.PARTS);         if (shP.getLastRow()===0) shP.appendRow(CFG.PARTS_HEADER);
  const shL = SH_(CFG.SHEETS.LOGS);          if (shL.getLastRow()===0) shL.appendRow(CFG.LOGS_HEADER);
  const shS = SH_(CFG.SHEETS.SETTINGS);      if (shS.getLastRow()===0) shS.appendRow(CFG.SETTINGS_HEADER);
  const shC = SH_(CFG.SHEETS.CUSTOMERS);     if (shC.getLastRow()===0) shC.appendRow(CFG.CUSTOMERS_HEADER);

  // Default settings
  const cur = getSettingsMap_();
  const need = Object.assign({}, CFG.DEFAULT_SETTINGS, cur);
  setSettingsMap_(need);

  // Folders
  getOrCreatePhotosFolder_();
  getOrCreateBackupFolder_();

  // Secrets defaults
  const sp = PropertiesService.getScriptProperties();
  if (!sp.getProperty('API_KEY')) sp.setProperty('API_KEY', Utilities.getUuid().slice(0,12));
  if (!sp.getProperty('WHATSAPP_PHONE')) sp.setProperty('WHATSAPP_PHONE', '');
  if (!sp.getProperty('WHATSAPP_APIKEY')) sp.setProperty('WHATSAPP_APIKEY', '');
  if (!sp.getProperty('TELEGRAM_BOT_TOKEN')) sp.setProperty('TELEGRAM_BOT_TOKEN', '');
  if (!sp.getProperty('TELEGRAM_CHAT_ID'))   sp.setProperty('TELEGRAM_CHAT_ID', '');

  return 'Setup OK';
}

/******************* HTTP *******************/
function jsonOrJsonp_(obj, cb){
  const t = cb ? `${cb}(${JSON.stringify(obj)})` : JSON.stringify(obj);
  return ContentService.createTextOutput(t)
    .setMimeType(cb ? ContentService.MimeType.JAVASCRIPT : ContentService.MimeType.JSON);
}
function json_(obj){
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet(e){
  try{
    requireApiKey_(e);
    const fn = e.parameter.fn || 'health';
    const cb = e.parameter.callback || e.parameter.cb;

    if (fn==='health')        return jsonOrJsonp_({ok:true, ts:new Date()}, cb);
    if (fn==='listTickets')   return jsonOrJsonp_(api_listTickets_(e), cb);
    if (fn==='listAll')       return jsonOrJsonp_(api_listAllTickets_(), cb);
    if (fn==='listTechs')     return jsonOrJsonp_(api_listTechs_(), cb);
    if (fn==='getTicket')     return jsonOrJsonp_(api_getTicket_(e), cb);
    if (fn==='listSettings')  return jsonOrJsonp_(api_listSettings_(), cb);
    if (fn==='getUpdates')    return jsonOrJsonp_(tg_getUpdates_(), cb);
    if (fn==='selfTest')      return selfTestHttp_(e);

    return jsonOrJsonp_({ok:false, error:'unknown fn'}, cb);
  }catch(ex){
    return jsonOrJsonp_({ok:false, error: ex.message}, e?.parameter?.callback||e?.parameter?.cb);
  }
}

function doPost(e){
  try{
    requireApiKey_(e);
    const body = JSON.parse(e.postData.contents||'{}');
    const fn = body.fn;

    if (fn==='updateTicket')          return json_(api_updateTicket_(body.payload||{}));
    if (fn==='uploadPhotos')          return json_(api_uploadPhotos_(body.payload||{}));
    if (fn==='assignTicket')          return json_(api_assignTicket_(body.payload||{}));
    if (fn==='notify')                return json_(api_notify_(body.payload||{}));
    if (fn==='saveSettings')          return json_(api_saveSettings_(body.payload||{}));
    if (fn==='addCustomer')           return json_(api_addCustomer_(body.payload||{}));
    if (fn==='createTicketAndAssign') return json_(api_createTicketAndAssign_(body.payload||{}));
    if (fn==='upsertCustomersBulk')   return json_(api_upsertCustomersBulk_(body.payload||{}));
    if (fn==='addTicket')             return json_(api_addTicket_(body.payload||{}));

    return json_({ok:false, error:'unknown fn'});
  }catch(ex){
    return json_({ok:false, error: ex.message});
  }
}

/******************* API CORE *******************/
function withLock_(fn){
  const lock = LockService.getScriptLock();
  lock.tryLock(30000);
  try{ return fn(); } finally { lock.releaseLock(); }
}

function api_listTechs_(){
  const sh = SH_(CFG.SHEETS.TECHS);
  const {hdr, data} = readAll_(sh);
  const C = col_(hdr);
  const rows = data.map(r => ({
    tech_id: r[C('tech_id')],
    name:    r[C('name')],
    phone:   r[C('phone')]
  }));
  return {ok:true, data: rows};
}

function api_listTickets_(e){
  const engineer = e.parameter.engineer || ''; // اسم أو tech_id
  const status   = e.parameter.status || '';
  const sh = SH_(CFG.SHEETS.TICKETS);
  const {hdr, data} = readAll_(sh);
  const C = col_(hdr);
  const rows = data.filter(r=>{
    let ok = true;
    if (engineer){
      ok = (String(r[C('assigned_to')])===engineer) || (String(r[C('assigned_to_id')])===engineer);
    }
    if (status) ok = ok && (String(r[C('status')]||'') === status);
    return ok;
  }).map(r=> rowToTicket_(hdr, r));
  return {ok:true, data: rows};
}
function api_listAllTickets_(){
  const sh = SH_(CFG.SHEETS.TICKETS);
  const {hdr, data} = readAll_(sh);
  return {ok:true, data: data.map(r=> rowToTicket_(hdr, r))};
}
function api_getTicket_(e){
  const id = e.parameter.ticket_id;
  const sh = SH_(CFG.SHEETS.TICKETS);
  const {hdr, data} = readAll_(sh);
  const C = col_(hdr);
  for (let i=0;i<data.length;i++){
    const r = data[i];
    if (String(r[C('ticket_id')]) === id) return {ok:true, data: rowToTicket_(hdr, r)};
  }
  throw new Error('Ticket not found');
}

function api_updateTicket_(p){
  return withLock_(()=> {
    const sh = SH_(CFG.SHEETS.TICKETS);
    const {hdr, data} = readAll_(sh);
    ensureCols_(sh, hdr, ['address_detail','order_notes','engineer_notes','pulled_parts','deposit','total','closed_at','last_update','due_at','assigned_to_id']);
    const hdr2 = readHeader_(sh); const C2 = col_(hdr2);
    const C = col_(hdr);

    for (let i=0;i<data.length;i++){
      const r = data[i]; const row = i+2;
      const isMine = !p.engineer || String(r[C('assigned_to')])===p.engineer || String(r[C('assigned_to_id')])===p.engineer;
      if (String(r[C('ticket_id')]) === p.ticket_id && isMine){
        if (p.address_detail!=null)   sh.getRange(row, C2('address_detail')+1).setValue(p.address_detail);
        if (p.order_notes!=null)      sh.getRange(row, C2('order_notes')+1).setValue(p.order_notes);
        if (p.engineer_notes!=null)   sh.getRange(row, C2('engineer_notes')+1).setValue(p.engineer_notes);
        if (p.pulled_parts!=null)     sh.getRange(row, C2('pulled_parts')+1).setValue(p.pulled_parts);
        if (p.deposit!==undefined)    sh.getRange(row, C2('deposit')+1).setValue(Number(p.deposit||0));
        if (p.total!==undefined)      sh.getRange(row, C2('total')+1).setValue(Number(p.total||0));
        if (p.status)                 sh.getRange(row, C2('status')+1).setValue(String(p.status));
        if (p.due_at)                 sh.getRange(row, C2('due_at')+1).setValue(new Date(p.due_at));
        sh.getRange(row, C2('last_update')+1).setValue(new Date());

        if (p.markDone){
          sh.getRange(row, C2('status')+1).setValue('done');
          sh.getRange(row, C2('closed_at')+1).setValue(new Date());
          log_('Close Ticket', p.ticket_id, p.engineer||r[C('assigned_to')], r[C('customer_name')], 'تم الإغلاق', 'لوحة المهندس');
        } else {
          log_('Update Ticket', p.ticket_id, p.engineer||r[C('assigned_to')], r[C('customer_name')], 'تحديث بيانات التذكرة', 'لوحة المهندس');
        }
        return {ok:true, updated:true};
      }
    }
    throw new Error('Not found or not assigned');
  });
}

function api_uploadPhotos_(p){
  return withLock_(()=> {
    const folder = getOrCreatePhotosFolder_();
    const shT = SH_(CFG.SHEETS.TICKETS);
    const {hdr, data} = readAll_(shT); const C = col_(hdr);
    let rowFound = -1; let oldLinks = [];
    for (let i=0;i<data.length;i++){
      const r = data[i];
      const isMine = !p.engineer || String(r[C('assigned_to')])===p.engineer || String(r[C('assigned_to_id')])===p.engineer;
      if (String(r[C('ticket_id')])===p.ticket_id && isMine){
        rowFound = i+2; const prev = r[C('device_images')]; if (prev) oldLinks = String(prev).split('\n').filter(Boolean);
        break;
      }
    }
    if (rowFound === -1) throw new Error('ticket not found or not assigned');

    const links = [];
    (p.photos||[]).forEach((dataUrl,k)=>{ if(!dataUrl) return;
      const f = dataUrlToFile_(dataUrl, `${p.ticket_id}_photo_${Date.now()}_${k}.jpg`, folder, p.customer_name, p.tech_name);
      links.push(f.getUrl());
    });

    if (p.parts && p.parts.length){
      const shP = SH_(CFG.SHEETS.PARTS);
      const techId = String(p.engineer||'');
      p.parts.forEach((pp,j)=>{
        let fid = '';
        if (pp.dataUrl){
          const f = dataUrlToFile_(pp.dataUrl, `${p.ticket_id}_${pp.name||'part'}_${Date.now()}_${j}.jpg`, folder, p.customer_name, p.tech_name);
          fid = f.getId(); links.push(f.getUrl());
        }
        shP.appendRow([
          `PP-${Utilities.getUuid().slice(0,8)}`, p.ticket_id, p.customer_name, techId, p.tech_name||'',
          (pp.name||'').trim(), Number(pp.qty||1), fid
        ]);
      });
    }

    const all = oldLinks.concat(links).join('\n');
    const C2 = col_(readHeader_(shT));
    shT.getRange(rowFound, C2('device_images')+1).setValue(all);
    log_('Upload Photos', p.ticket_id, p.engineer||'', p.customer_name||'', `عدد ${links.length}`, 'لوحة المهندس');
    return {ok:true, uploaded: links.length};
  });
}

function api_assignTicket_(p){
  return withLock_(()=> {
    const sh = SH_(CFG.SHEETS.TICKETS); const {hdr, data} = readAll_(sh); const C = col_(hdr);
    ensureCols_(sh, hdr, ['assigned_to_id']);
    const hdr2 = readHeader_(sh); const C2 = col_(hdr2);

    const shX = SH_(CFG.SHEETS.TECHS);
    const L = readAll_(shX);
    const CX = col_(L.hdr);
    const byId = (L.data||[]).reduce((m,r)=> (m[String(r[CX('tech_id')])] = {name:r[CX('name')], phone:r[CX('phone')]}, m), {});
    const byName = (L.data||[]).reduce((m,r)=> (m[String(r[CX('name')])] = {id:r[CX('tech_id')], phone:r[CX('phone')]}, m), {});

    let rowFound = -1; let customerName = p.customer_name || '';
    for (let i=0;i<data.length;i++){
      const r = data[i];
      if (String(r[C('ticket_id')])===p.ticket_id){ rowFound = i+2; customerName = customerName || r[C('customer_name')] || ''; break; }
    }
    if (rowFound === -1) throw new Error('Ticket not found');

    // p.engineer قد يكون tech_id أو name
    let techName = '', techId = '';
    if (p.engineer && byId[p.engineer]){ techId = p.engineer; techName = byId[p.engineer].name; }
    else if (p.engineer && byName[p.engineer]){ techName = p.engineer; techId = byName[p.engineer].id; }
    else { techName = p.engineer||''; }

    sh.getRange(rowFound, C2('assigned_to')+1).setValue(techName);
    if (techId) sh.getRange(rowFound, C2('assigned_to_id')+1).setValue(techId);
    sh.getRange(rowFound, C2('status')+1).setValue('new');

    const msg = `تذكرة جديدة: ${p.ticket_id}\nعميل: ${customerName||'-'}\nهاتف: ${p.phone||'-'}\nموجز: ${p.summary||'-'}`;
    const settings = getSettingsMap_();
    if (String(settings.NOTIFY_WA||'true').toLowerCase()==='true' || String(settings.NOTIFY_TG||'false').toLowerCase()==='true'){
      notifyAllDebounced_(`assign_${p.ticket_id}`, msg, 60);
    }
    log_('Assign Ticket', p.ticket_id, techName, customerName, p.summary||'', 'لوحة المدير');
    return {ok:true, assigned:true, assigned_to: techName, assigned_to_id: techId};
  });
}

function api_notify_(p){
  notifyAllDebounced_('manual', p.message||'', 30);
  log_('Notify', '', '', '', p.message||'', 'لوحة المدير');
  return {ok:true};
}

/******** Settings ********/
function api_listSettings_(){ return {ok:true, data: getSettingsMap_()}; }
function api_saveSettings_(payload){ setSettingsMap_(payload||{}); return {ok:true, saved:true, data:getSettingsMap_()}; }

/******** Customers ********/
function api_addCustomer_(p){
  return withLock_(()=> {
    const sh = SH_(CFG.SHEETS.CUSTOMERS);
    if (sh.getLastRow()===0) sh.appendRow(CFG.CUSTOMERS_HEADER);
    const vals = sh.getDataRange().getValues();
    const hdr = vals[0]; const C=(n)=>hdr.indexOf(n);
    const normPhone = String(p.phone||'').replace(/\D/g,'');
    for (let i=1;i<vals.length;i++){
      const r = vals[i];
      if (String(r[C('phone')]).replace(/\D/g,'') === normPhone){
        sh.getRange(i+1, C('name')+1).setValue(p.name||r[C('name')]);
        sh.getRange(i+1, C('address')+1).setValue(p.address||r[C('address')]);
        sh.getRange(i+1, C('last_seen')+1).setValue(new Date());
        return {ok:true, updated:true, customer_id: r[C('customer_id')]}};
    }
    const id = 'C-'+Utilities.getUuid().slice(0,8);
    sh.appendRow([id, p.name||'', normPhone, p.address||'', new Date(), new Date(), 0]);
    return {ok:true, created:true, customer_id:id};
  });
}

function api_upsertCustomersBulk_(p){
  return withLock_(()=> {
    const rows = p.rows||[];
    const sh = SH_(CFG.SHEETS.CUSTOMERS);
    if (sh.getLastRow()===0) sh.appendRow(CFG.CUSTOMERS_HEADER);

    const vals = sh.getDataRange().getValues();
    const hdr = vals[0]; const C=(n)=>hdr.indexOf(n);
    const mapPhoneRow = {};
    for (let i=1;i<vals.length;i++){
      const r=vals[i];
      const phone = String(r[C('phone')]).replace(/\D/g,'');
      if (phone) mapPhoneRow[phone] = i+1;
    }
    let updated=0, created=0;
    rows.forEach(x=>{
      const phone = String(x.phone||'').replace(/\D/g,''); if (!phone) return;
      const name  = x.name||''; const addr = x.address||'';
      const rowIdx = mapPhoneRow[phone];
      if (rowIdx){
        sh.getRange(rowIdx, C('name')+1).setValue(name || sh.getRange(rowIdx, C('name')+1).getValue());
        sh.getRange(rowIdx, C('address')+1).setValue(addr || sh.getRange(rowIdx, C('address')+1).getValue());
        sh.getRange(rowIdx, C('last_seen')+1).setValue(new Date());
        updated++;
      } else {
        const id = 'C-'+Utilities.getUuid().slice(0,8);
        sh.appendRow([id, name, phone, addr, new Date(), new Date(), 0]);
        created++;
      }
    });
    return {ok:true, count: updated+created, updated, created};
  });
}

/******** Create + Assign + Send link ********/
function api_createTicketAndAssign_(p){
  return withLock_(()=> {
    const shT = SH_(CFG.SHEETS.TICKETS);
    if (shT.getLastRow()===0) shT.appendRow(CFG.TICKETS_HEADER);
    const id = 'T-'+Utilities.getUuid().slice(0,8);
    shT.appendRow([
      id, '', p.customer_name||'', p.phone||'', p.address||'',
      p.device_type||'', p.problem_desc||'', 'new', '', '', new Date(), '',
      '', '', '', '', '', '', '', '', '' // باقي الأعمدة
    ]);

    // assign
    const asn = api_assignTicket_({ ticket_id:id, engineer:p.tech_id||p.engineer, customer_name:p.customer_name, phone:p.phone, summary:p.problem_desc });

    // link for engineer
    const baseEng = p.engineer_base || 'https://example.com/engineer-dashboard.html';
    const url = `${baseEng}?engineer=${encodeURIComponent(asn.assigned_to_id || asn.assigned_to)}&ticket=${encodeURIComponent(id)}${p.api_key_for_link?`&key=${encodeURIComponent(p.api_key_for_link)}`:''}`;

    // WhatsApp direct to engineer phone (optional)
    try{
      const techs = api_listTechs_().data||[]; 
      const tech = techs.find(t=> String(t.tech_id)===String(asn.assigned_to_id)) || techs.find(t=> t.name===asn.assigned_to);
      if (tech?.phone){
        const msg = `تذكرة جديدة #${id}\nعميل: ${p.customer_name||'-'}\nجهاز: ${p.device_type||'-'}\n${p.problem_desc||'-'}\n${url}`;
        wa_send_to_(tech.phone, msg);
      }
    }catch(e){ Logger.log('WA engineer link error: '+e); }

    log_('Create+Assign', id, asn.assigned_to, p.customer_name||'', 'من لوحة المدير', 'لوحة المدير');
    return {ok:true, ticket_id:id, link:url, engineer_name: asn.assigned_to, engineer_id: asn.assigned_to_id||''};
  });
}

/******** Add Ticket (مدير) ********/
function api_addTicket_(p){
  const sh = SH_(CFG.SHEETS.TICKETS);
  const hdr = readHeader_(sh);
  const C = col_(hdr);
  // يولّد ID إذا مش مرسل
  const id = p.ticket_id || ('T-' + Utilities.getUuid().slice(0,8));
  const row = new Array(hdr.length).fill('');

  const set = (name, val) => { const i = C(name); if (i > -1) row[i] = val; };

  set('ticket_id', id);
  set('customer_id', p.customer_id || '');
  set('customer_name', p.customer_name || '');
  set('phone', p.phone || '');
  set('address', p.address || '');
  set('device_type', p.device_type || '');
  set('problem_desc', p.problem_desc || '');
  set('status', p.status || 'new');
  set('assigned_to', p.assigned_to || '');
  set('opened_at', new Date());
  set('deposit', Number(p.deposit || 0));
  set('total',   Number(p.total   || 0));
  set('address_detail', p.address_detail || '');
  set('order_notes',    p.order_notes    || '');

  sh.appendRow(row);
  log_('Add Ticket', id, p.assigned_to||'', p.customer_name||'', 'إنشاء من لوحة المدير', 'لوحة المدير');
  return { ok:true, ticket_id:id };
}

/******************* NOTIFY *******************/
function notifyAll_(message){
  try{ wa_send_(message); }catch(e){ Logger.log('WA error: '+e); }
  try{ tg_send_(message); }catch(e){ Logger.log('TG error: '+e); }
}
function notifyAllDebounced_(key, message, seconds){
  const cache = CacheService.getScriptCache();
  const k = 'ntf_'+key;
  if (cache.get(k)) return 'skip';
  if (message) notifyAll_(message);
  cache.put(k, '1', seconds||60);
}
function wa_send_(text){
  const sp = PropertiesService.getScriptProperties();
  const phone = sp.getProperty('WHATSAPP_PHONE'); // رقم إداري أو مجموعة
  const apikey= sp.getProperty('WHATSAPP_APIKEY');
  const settings = getSettingsMap_();
  if (String(settings.NOTIFY_WA||'true').toLowerCase()!=='true') return 'skip-wa-disabled';
  const norm = String(phone||'').replace(/\D/g,'');
  if (!norm || !apikey || !text) return 'skip-wa';
  const url = 'https://api.callmebot.com/whatsapp.php';
  const params = { method:'post', payload: { phone: norm, text, apikey } };
  const r = UrlFetchApp.fetch(url, params);
  return r.getResponseCode();
}
function wa_send_to_(phone, text){
  const apikey= PropertiesService.getScriptProperties().getProperty('WHATSAPP_APIKEY');
  const settings = getSettingsMap_();
  if (String(settings.NOTIFY_WA||'true').toLowerCase()!=='true') return 'skip-wa-disabled';
  const norm = String(phone||'').replace(/\D/g,'');
  if (!norm || !apikey || !text) return 'skip-wa';
  const url = 'https://api.callmebot.com/whatsapp.php';
  const params = { method:'post', payload: { phone: norm, text, apikey } };
  const r = UrlFetchApp.fetch(url, params);
  return r.getResponseCode();
}
function tg_send_(text){
  const sp = PropertiesService.getScriptProperties();
  const token = sp.getProperty('TELEGRAM_BOT_TOKEN');
  const chat  = sp.getProperty('TELEGRAM_CHAT_ID');
  const settings = getSettingsMap_();
  if (String(settings.NOTIFY_TG||'false').toLowerCase()!=='true') return 'skip-tg-disabled';
  if (!token || !chat || !text) return 'skip-tg';
  const url = `https://api.telegram.org/bot${token}/sendMessage`;
  const payload = { chat_id: chat, text, parse_mode: 'HTML' };
  const r = UrlFetchApp.fetch(url, { method:'post', contentType:'application/json', payload: JSON.stringify(payload) });
  return r.getResponseCode();
}
function tg_getUpdates_(){
  const token = PropertiesService.getScriptProperties().getProperty('TELEGRAM_BOT_TOKEN');
  if (!token) return {ok:false, error:'Set TELEGRAM_BOT_TOKEN first'};
  const url = `https://api.telegram.org/bot${token}/getUpdates`;
  const r = UrlFetchApp.fetch(url);
  return JSON.parse(r.getContentText());
}

/******************* HELPERS *******************/
function SH_(name){ return SpreadsheetApp.getActive().getSheetByName(name) || SpreadsheetApp.getActive().insertSheet(name); }
function readAll_(sh){ const rng = sh.getDataRange(); const vals = rng.getValues(); return {hdr: vals[0], data: vals.slice(1)}; }
function readHeader_(sh){ return sh.getRange(1,1,1,Math.max(1, sh.getLastColumn())).getValues()[0]; }
function col_(hdr){ return (name)=> hdr.indexOf(name); }
function ensureCols_(sh, hdr, needed){
  let local = hdr.slice();
  needed.forEach(n=>{
    if (local.indexOf(n)===-1){
      sh.insertColumnAfter(sh.getLastColumn());
      sh.getRange(1, sh.getLastColumn()).setValue(n);
      local.push(n);
    }
  });
}
function rowToTicket_(hdr, r){
  const C = col_(hdr);
  return {
    ticket_id:r[C('ticket_id')], customer_id:r[C('customer_id')],
    customer_name:r[C('customer_name')], phone:r[C('phone')], address:r[C('address')],
    device_type:r[C('device_type')], problem_desc:r[C('problem_desc')],
    status:r[C('status')], assigned_to:r[C('assigned_to')], assigned_to_id:r[C('assigned_to_id')],
    opened_at:r[C('opened_at')], closed_at:r[C('closed_at')], deposit:r[C('deposit')], total:r[C('total')],
    address_detail:r[C('address_detail')], order_notes:r[C('order_notes')], engineer_notes:r[C('engineer_notes')],
    pulled_parts:r[C('pulled_parts')], device_images:r[C('device_images')], due_at:r[C('due_at')], last_update:r[C('last_update')]
  };
}
function getOrCreatePhotosFolder_(){ const it = DriveApp.getFoldersByName(CFG.PHOTOS_FOLDER); return it.hasNext()? it.next() : DriveApp.createFolder(CFG.PHOTOS_FOLDER); }
function getOrCreateBackupFolder_(){ const it = DriveApp.getFoldersByName(CFG.BACKUP_FOLDER); return it.hasNext()? it.next() : DriveApp.createFolder(CFG.BACKUP_FOLDER); }
function dataUrlToFile_(dataUrl, filename, folder, customerName, techName){
  const parts = (dataUrl||'').split(','); if (parts.length<2) throw new Error('Bad dataUrl');
  const mime = (parts[0].match(/data:(.*);base64/)||[])[1] || 'image/jpeg';
  const bytes = Utilities.base64Decode(parts[1]);
  const blob = Utilities.newBlob(bytes, mime, filename);
  const f = folder.createFile(blob).setName(filename);
  f.setDescription(`Customer:${customerName||''} | Engineer:${techName||''}`);
  try { f.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch(e){}
  return f;
}

/******** Settings helpers ********/
function getSettingsMap_(){
  const sh = SH_(CFG.SHEETS.SETTINGS);
  if (sh.getLastRow()<2) return Object.assign({}, CFG.DEFAULT_SETTINGS);
  const vals = sh.getRange(2,1, sh.getLastRow()-1, 2).getValues();
  const map = {}; vals.forEach(r=>{ if (r[0]) map[String(r[0]).trim()] = String(r[1]??''); });
  return Object.assign({}, CFG.DEFAULT_SETTINGS, map);
}
function setSettingsMap_(obj){
  const sh = SH_(CFG.SHEETS.SETTINGS);
  const cur = getSettingsMap_();
  const merged = Object.assign({}, cur, obj||{});
  sh.clear(); sh.appendRow(CFG.SETTINGS_HEADER);
  Object.keys(merged).forEach(k=> sh.appendRow([k, merged[k]]));
  return merged;
}

/******************* LOGS & BACKUP & CRON *******************/
function log_(action, ticket_id, engineer, customer, details, actor){
  const sh = SH_(CFG.SHEETS.LOGS);
  const ts = Utilities.formatDate(new Date(), CFG.TZ, 'yyyy-MM-dd HH:mm:ss');
  sh.appendRow([ts, actor||'', action||'', ticket_id||'', engineer||'', customer||'', details||'']);
}
function backupDaily(){
  // لازم تفعّل Advanced Drive API لهذا المشروع
  const ss = SpreadsheetApp.getActive();
  const name = `${ss.getName()}__${Utilities.formatDate(new Date(), CFG.TZ, 'yyyyMMdd_HHmm')}.xlsx`;
  const blob = Drive.Files.export(ss.getId(), 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  const folder = getOrCreateBackupFolder_();
  folder.createFile(blob).setName(name);
  return 'backup created';
}
function setupBackupTrigger(){
  ScriptApp.getProjectTriggers().forEach(t=>{ if (t.getHandlerFunction()==='backupDaily') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('backupDaily').timeBased().everyDays(1).atHour(3).create();
  return 'backup trigger set';
}
function notifyOverdueDaily(){
  const sh = SH_(CFG.SHEETS.TICKETS);
  const {hdr, data} = readAll_(sh);
  const C = col_(hdr);
  const now = new Date();
  const overdue = [];
  data.forEach(r=>{
    const status = String(r[C('status')]||'');
    if (status==='done') return;
    const due = r[C('due_at')] ? new Date(r[C('due_at')]) : null;
    const opened = r[C('opened_at')] ? new Date(r[C('opened_at')]) : null;
    const late = (due && now>due) || (!due && opened && ((now-opened)/(1000*3600*24) >= 3));
    if (late){
      overdue.push({ ticket_id:r[C('ticket_id')], engineer:r[C('assigned_to')], customer:r[C('customer_name')], phone:r[C('phone')] });
    }
  });
  if (!overdue.length) return {ok:true, count:0};
  const msg = 'تنبيه: تذاكر متأخرة:\n' + overdue.map(o=>`- ${o.ticket_id} (${o.customer||'-'})`).join('\n');
  notifyAllDebounced_('overdue_'+Utilities.getUuid().slice(0,6), msg, 300);
  log_('OverdueNotify', '', '', '', `count=${overdue.length}`, 'Cron');
  return {ok:true, count:overdue.length};
}
function setupOverdueTrigger(){
  ScriptApp.getProjectTriggers().forEach(t=>{ if (t.getHandlerFunction()==='notifyOverdueDaily') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('notifyOverdueDaily').timeBased().everyDays(1).atHour(9).create();
  return 'overdue trigger set';
}

/******************* SELF TEST *******************/
function selfTestLocal(send){ return selfTestCore_(send===true); }
function selfTestHttp_(e){
  const send = String(e.parameter.send||'false').toLowerCase()==='true';
  const rep = selfTestCore_(send);
  return ContentService.createTextOutput(JSON.stringify({ok:true, report:rep})).setMimeType(ContentService.MimeType.JSON);
}
function selfTestCore_(doSend){
  const TZ = CFG.TZ;
  const now = Utilities.formatDate(new Date(), TZ, 'yyyy-MM-dd HH:mm:ss');
  const sp = PropertiesService.getScriptProperties();
  const mustSheets = Object.values(CFG.SHEETS);

  const keys = {
    API_KEY: !!sp.getProperty('API_KEY'),
    WHATSAPP_PHONE: !!sp.getProperty('WHATSAPP_PHONE'),
    WHATSAPP_APIKEY: !!sp.getProperty('WHATSAPP_APIKEY'),
    TELEGRAM_BOT_TOKEN: !!sp.getProperty('TELEGRAM_BOT_TOKEN'),
    TELEGRAM_CHAT_ID: !!sp.getProperty('TELEGRAM_CHAT_ID')
  };
  const ss = SpreadsheetApp.getActive();
  const sheets = {};
  mustSheets.forEach(n=>{
    const sh = ss.getSheetByName(n);
    sheets[n] = { exists: !!sh, headers: [], headersOk: null };
    if (sh){
      const hdr = sh.getRange(1,1,1, Math.max(1, sh.getLastColumn())).getValues()[0];
      sheets[n].headers = hdr;
      if (n==='Tickets'){
        const need = ['ticket_id','customer_name','phone','address','device_type','problem_desc','status','assigned_to','opened_at'];
        sheets[n].headersOk = need.every(h=> hdr.indexOf(h) !== -1);
      } else if (n==='Technicians'){
        sheets[n].headersOk = ['tech_id','name','phone'].every(h=> hdr.indexOf(h) !== -1);
      } else if (n==='PulledParts'){
        const need = ['id','ticket_id','customer_name','tech_id','tech_name','part_name','qty','photo_file_id'];
        sheets[n].headersOk = need.every(h=> hdr.indexOf(h) !== -1);
      } else if (n==='Logs'){
        const need = ['ts','actor','action','ticket_id','engineer','customer','details'];
        sheets[n].headersOk = need.every(h=> hdr.indexOf(h) !== -1);
      } else if (n==='Settings'){
        sheets[n].headersOk = hdr[0]==='key' && hdr[1]==='value';
      } else if (n==='Customers'){
        sheets[n].headersOk = ['customer_id','name','phone'].every(h=> hdr.indexOf(h) !== -1);
      }
    }
  });

  const settings = getSettingsMap_();
  const settingsOk = ['COMPANY_NAME','PRIMARY_COLOR','FONT_FAMILY','REQUIRE_ADDRESS_DETAIL','REQUIRE_NOTES','REQUIRE_PHOTO','NOTIFY_WA','NOTIFY_TG']
    .every(k=> k in settings);

  let photosFolderOK = true, backupFolderOK = true;
  try{ getOrCreatePhotosFolder_(); }catch(e){ photosFolderOK = false; }
  try{ getOrCreateBackupFolder_(); }catch(e){ backupFolderOK = false; }

  const shT = ss.getSheetByName('Tickets');
  const shX = ss.getSheetByName('Technicians');
  let ticketsCount = 0, techsCount = 0;
  try{ ticketsCount = Math.max(0, (shT?.getLastRow()||1)-1); }catch(e){}
  try{ techsCount   = Math.max(0, (shX?.getLastRow()||1)-1); }catch(e){}

  let notifyTried = false, notifyResult = 'skipped';
  if (doSend){ notifyTried = true; try{ notifyAllDebounced_('selftest_'+Date.now(), 'اختبار ذاتي للنظام ✅ ('+now+')', 10); notifyResult = 'sent'; }catch(e){ notifyResult='error:'+e.message; } }

  const tips = [];
  if (!keys.API_KEY) tips.push('ضبط Script Property باسم API_KEY مطلوب.');
  if (!sheets.Tickets?.exists) tips.push('ورقة Tickets غير موجودة — شغّل setupAll().');
  if (sheets.Tickets?.exists && sheets.Tickets.headersOk===false) tips.push('رؤوس Tickets ناقصة — شغّل setupAll() أو صحح الرؤوس.');
  if (!sheets.Technicians?.exists) tips.push('أضف ورقة Technicians وأدخل مهندس واحد على الأقل.');
  if (ticketsCount===0) tips.push('لا توجد تذاكر — جرّب إضافة تذكرة اختبارية.');
  if (!photosFolderOK) tips.push('فشل إنشاء/الوصول إلى مجلد الصور على Drive.');
  if (!backupFolderOK) tips.push('فشل إنشاء/الوصول إلى مجلد النسخ الاحتياطي على Drive.');

  return {
    ts: now, keys, sheets, settingsSummary: { ok: settingsOk, ...settings },
    drive: { photosFolderOK, backupFolderOK },
    counts: { tickets: ticketsCount, technicians: techsCount },
    notify: { tried: notifyTried, result: notifyResult },
    suggestions: tips
  };
}

/******** TEST SHORTCUTS ********/
function test_setup(){ return setupAll(); }
function test_notify(){ notifyAll_('اختبار الإشعارات ✅'); return 'sent'; }
