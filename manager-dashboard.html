<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مصر تكنولوجى — لوحة المدير</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

  <style>
    :root { --primary:#f97316; --bg:#faf8f5; --card:#fff; --text:#111 }
    body { font-family:'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text) }
    .navbar { background:var(--primary)!important }
    .btn-primary { background:var(--primary); border-color:var(--primary) }
    .btn-primary:hover { filter:brightness(.95) }
    .card { border:none; border-radius:1rem; box-shadow:0 6px 18px rgba(0,0,0,.06) }
    .kpi { color:#fff; border-radius:1rem }
    .pill{ border-radius:999px; font-size:.75rem; padding:.25rem .6rem; display:inline-block }
    .pill-new{ background:#fff4ea; color:var(--primary) }
    .pill-inp{ background:#eaf6ff; color:#0ea5e9 }
    .pill-done{ background:#eafaf0; color:#16a34a }
    .pill-cancel{ background:#eee; color:#555 }
    .form-control,.form-select{ border-radius:.8rem }
    .offcanvas{ width:min(560px, 100vw) }
    .badge-overdue{ background:#ef4444 }
  </style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f97316">
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#"><i class="fa-solid fa-screwdriver-wrench me-2"></i><span id="brandName">مصر تكنولوجى</span></a>
      <div class="d-flex gap-2">
        <button class="btn btn-light" onclick="document.getElementById('xlsCustomers').click()"><i class="fa-solid fa-file-excel me-1"></i> استيراد عملاء</button>
        <button class="btn btn-light" onclick="window.print()"><i class="fa-solid fa-print me-1"></i> طباعة</button>
        <input id="xlsCustomers" type="file" accept=".xlsx,.xls,.csv" hidden>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-4"><label class="form-label">بحث</label><input id="q" class="form-control" placeholder="ابحث باسم العميل / رقم التذكرة / نوع الجهاز" /></div>
      <div class="col-md-2"><label class="form-label">المهندس</label><select id="fltTech" class="form-select"></select></div>
      <div class="col-md-2"><label class="form-label">الحالة</label>
        <select id="fltStatus" class="form-select">
          <option value="">كل الحالات</option><option value="new">new</option><option value="in_progress">in_progress</option><option value="done">done</option><option value="cancelled">cancelled</option>
        </select>
      </div>
      <div class="col-md-2"><label class="form-label">من</label><input id="from" type="date" class="form-control" /></div>
      <div class="col-md-2"><label class="form-label">إلى</label><input id="to" type="date" class="form-control" /></div>
    </div>

    <div class="d-flex gap-2 mb-4">
      <button id="btnSearch" class="btn btn-primary"><i class="fa-solid fa-filter me-1"></i> بحث</button>
      <button id="btnReset" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate-left me-1"></i> مسح</button>
      <div class="ms-auto d-flex gap-2">
        <button id="btnExportCSV" class="btn btn-success"><i class="fa-solid fa-file-csv me-1"></i> CSV</button>
        <button id="btnExportXLSX" class="btn btn-success"><i class="fa-solid fa-file-excel me-1"></i> Excel</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:var(--primary)"><div class="small opacity-75">إجمالي التذاكر</div><div class="h4 m-0" id="kpiTotal">0</div></div></div>
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:#0ea5e9"><div class="small opacity-75">قيد التنفيذ</div><div class="h4 m-0" id="kpiInProg">0</div></div></div>
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:#22c55e"><div class="small opacity-75">مكتملة</div><div class="h4 m-0" id="kpiDone">0</div></div></div>
      <div class="col-sm-6 col-lg-3"><div class="kpi p-3" style="background:#a78bfa"><div class="small opacity-75">إيراد الشهر</div><div class="h4 m-0" id="kpiRevenue">0</div></div></div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="m-0">التذاكر</h5>
          <div>
            <span class="pill pill-new">جديد</span>
            <span class="pill pill-inp ms-1">قيد التنفيذ</span>
            <span class="pill pill-done ms-1">مكتمل</span>
          </div>
        </div>
        <div class="table-responsive">
          <table id="tbl" class="table table-striped align-middle" style="width:100%">
            <thead><tr>
              <th>رقم</th><th>العميل</th><th>المهندس</th><th>الحالة</th><th>التاريخ</th>
              <th>العربون</th><th>الإجمالي</th><th>صور</th><th>إسناد</th><th>إجراءات</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
  </script>

<script>
\
// ===== الإعدادات العامة: قراءة config.json + دعم ?key= للتخزين المحلي =====
window.APP_CONFIG = {
  API_BASE: '',
  API_KEY: '',
  DEFAULT_COUNTRY_CODE: '20',
  COMPANY_NAME: 'لوحة إدارة الصيانة',
  PRIMARY_COLOR: '#f97316',
  FONT_FAMILY: 'Tajawal',
  POLICIES: { REQUIRE_ADDRESS_DETAIL:true, REQUIRE_NOTES:true, REQUIRE_PHOTO:false, NOTIFY_WA:true, NOTIFY_TG:false }
};
(function(){
  const qs = new URLSearchParams(location.search);
  const key = qs.get('key');
  if (key) localStorage.setItem('API_KEY', key);

  fetch('./config.json', {cache:'no-store'})
    .then(r => r.ok ? r.json() : {})
    .catch(()=>({}))
    .then(cfg => {
      Object.assign(window.APP_CONFIG, cfg||{});
      if (!window.APP_CONFIG.API_KEY) {
        window.APP_CONFIG.API_KEY = localStorage.getItem('API_KEY') || '';
      }
      if (window.APP_CONFIG.PRIMARY_COLOR) document.documentElement.style.setProperty('--primary', window.APP_CONFIG.PRIMARY_COLOR);
      if (window.APP_CONFIG.FONT_FAMILY) document.body.style.fontFamily = window.APP_CONFIG.FONT_FAMILY + ', system-ui, -apple-system, Segoe UI, Roboto, Arial';
      if (window.APP_CONFIG.COMPANY_NAME) {
        const el = document.getElementById('brandName');
        if (el) el.textContent = window.APP_CONFIG.COMPANY_NAME;
      }
      if (typeof window.__app_boot === 'function') window.__app_boot();
    });
})();


  const $ = s => document.querySelector(s);
  const statusPill = s => s==='in_progress' ? '<span class="pill pill-inp">قيد التنفيذ</span>' : (s==='done' ? '<span class="pill pill-done">مكتمل</span>' : (s==='cancelled' ? '<span class="pill pill-cancel">ملغي</span>' : '<span class="pill pill-new">جديد</span>'));
  async function apiGET(url){ const r=await fetch(url); const j=await r.json(); if(!j.ok) throw new Error(j.error||'API error'); return j; }
  async function apiPOST(body){ const r=await fetch(APP_CONFIG.API_BASE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(Object.assign({key:APP_CONFIG.API_KEY}, body)) }); const j=await r.json(); if(!j.ok) throw new Error(j.error||'API error'); return j; }

  function waDeepLink(phone, text){ const n=(phone||'').replace(/\D/g,''); return n ? `https://wa.me/${n}?text=${encodeURIComponent(text||'')}` : '#'; }

  let ALL = [], TECHS = []; let dt;

  async function fetchTickets(){
    const j = await apiGET(`${APP_CONFIG.API_BASE}?fn=listAll&key=${encodeURIComponent(APP_CONFIG.API_KEY)}`);
    return (j.data||[]).map(t=>({
      id:t.ticket_id, customer:t.customer_name, tech:t.assigned_to||'', status:t.status||'new', date:t.opened_at||'',
      dep:+(t.deposit||0), tot:+(t.total||0), notes:t.order_notes||'', images:(t.device_images||'')
    }));
  }
  async function fetchTechs(){
    const j = await apiGET(`${APP_CONFIG.API_BASE}?fn=listTechs&key=${encodeURIComponent(APP_CONFIG.API_KEY)}`);
    return (j.data||[]).map(x=>x.name).filter(Boolean);
  }
  async function assignTicket(payload){ return apiPOST({ fn:'assignTicket', payload }); }

  function fillTechFilters(){
    const sel=$('#fltTech'); sel.innerHTML=''; sel.insertAdjacentHTML('beforeend','<option value="">كل المهندسين</option>');
    TECHS.forEach(n=> sel.insertAdjacentHTML('beforeend',`<option>${n}</option>`));
  }
<button onclick="openTicketForm()">إضافة تذكرة جديدة</button>

<div id="ticketForm" style="display:none;">
  <input type="text" id="customerName" placeholder="اسم العميل">
  <input type="text" id="phone" placeholder="رقم الهاتف">
  <input type="text" id="address" placeholder="العنوان">
  <input type="text" id="deviceType" placeholder="نوع الجهاز">
  <input type="text" id="problemDesc" placeholder="وصف المشكلة">
  <input type="text" id="assignedTo" placeholder="اسم المهندس">
  <button onclick="saveTicket()">حفظ</button>
</div>

<script>
function openTicketForm() {
  document.getElementById("ticketForm").style.display = "block";
}

function saveTicket() {
  const data = {
    ticket_id: 'T-' + Date.now(),
    customer_name: document.getElementById("customerName").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    device_type: document.getElementById("deviceType").value,
    problem_desc: document.getElementById("problemDesc").value,
    status: 'new',
    assigned_to: document.getElementById("assignedTo").value
  };

  fetch(CONFIG.API_BASE, {
    method: 'POST',
    body: JSON.stringify({ fn: "addTicket", key: CONFIG.API_KEY, data }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(res => {
    if (res.ok) {
      alert("تم إضافة التذكرة بنجاح");
      location.reload();
    } else {
      alert("خطأ: " + res.error);
    }
  });
}
</script>

  function refreshTable(rows){
    if(dt){ dt.destroy(); $('#tbl tbody').innerHTML=''; }
    const tb = $('#tbl tbody'); tb.innerHTML='';
    rows.forEach(r=>{
      const imgs=(r.images||'').split('\n').filter(Boolean);
      const photos = imgs.length?`<a href="${imgs[0]}" target="_blank">${imgs.length} صورة</a>`:'—';
      const ageDays = r.date ? Math.floor((Date.now()-new Date(r.date).getTime())/86400000) : 0;
      const overdue = (r.status!=='done' && ageDays>=3) ? '<span class="badge bg-danger ms-1">متأخرة</span>' : '';
      tb.insertAdjacentHTML('beforeend',`<tr>
        <td>${r.id}</td>
        <td>${r.customer||''} ${overdue}</td>
        <td>${r.tech||''}</td>
        <td>${statusPill(r.status)} </td>
        <td>${r.date||''}</td>
        <td>${r.dep||0}</td>
        <td>${r.tot||0}</td>
        <td>${photos}</td>
        <td><button class="btn btn-sm btn-outline-primary" onclick="openAssign('${r.id}','${(r.customer||'').replace(/'/g,'\&#39;')}')">إسناد</button></td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-secondary" onclick="copyLink('${r.id}')">نسخ رابط</button>
        </td>
      </tr>`);
    });
    dt = new DataTable('#tbl', { language:{ url:'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json' }, pageLength:10 });
    $('#kpiTotal').textContent = rows.length;
    $('#kpiInProg').textContent = rows.filter(t=>t.status==='in_progress').length;
    $('#kpiDone').textContent   = rows.filter(t=>t.status==='done').length;
    const month = new Date().toISOString().slice(0,7);
    const rev = rows.filter(t=> (t.date||'').startsWith(month)).reduce((a,b)=> a + (Number(b.tot)||0), 0); 
    $('#kpiRevenue').textContent = rev.toLocaleString('ar-EG') + ' ج';
  }

  function applyFilters(){
    const q=($('#q').value||'').toLowerCase(); const te=$('#fltTech').value; const st=$('#fltStatus').value; const f=$('#from').value; const t=$('#to').value;
    const rows = ALL.filter(r=>{
      let ok=true;
      if(q) ok = ok && (`${r.id} ${r.customer} ${r.tech} ${r.notes}`.toLowerCase().includes(q));
      if(te) ok = ok && r.tech===te;
      if(st) ok = ok && r.status===st;
      if(f) ok = ok && new Date(r.date)>=new Date(f);
      if(t) ok = ok && new Date(r.date)<=new Date(t+'T23:59:59');
      return ok;
    });
    refreshTable(rows);
  }

  window.copyLink = (id)=>{ navigator.clipboard.writeText(location.href.split('#')[0]); alert('تم نسخ رابط الصفحة.'); };

  window.openAssign = async (id, customer)=>{
    const engineer = prompt('اسم المهندس المكلّف؟ (اختر من القائمة):\n' + TECHS.join(', '));
    if(!engineer) return;
    const phone = prompt('هاتف العميل (اختياري)?','');
    const summary = prompt('ملخص قصير للتذكرة/الموعد؟','');
    try{
      await assignTicket({ ticket_id:id, engineer, phone, summary, customer_name:customer });
      const engLink = `${location.origin+location.pathname.replace('manager-dashboard','engineer-dashboard')}engineer-dashboard.html?engineer=${encodeURIComponent(engineer)}`;
      alert('تم الإسناد وإرسال إشعار (من السكربت).');
      await reloadAll();
    }catch(e){ alert('تعذّر الإسناد: '+e.message); }
  };

  async function reloadAll(){
    ALL = await fetchTickets();
    try { TECHS = await fetchTechs(); } catch(e) { TECHS=[]; }
    fillTechFilters();
    refreshTable(ALL);
  }

  function exportCSV(rows){
    const header=['id','customer','tech','status','date','dep','tot','notes'];
    const csv=[header.join(',')].concat(rows.map(r=> header.map(h=> JSON.stringify(r[h]??'')).join(','))).join('\n');
    const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tickets.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function exportXLSX(rows){
    const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Tickets'); XLSX.writeFile(wb, 'tickets.xlsx');
  }
  $('#btnExportCSV').onclick = ()=> exportCSV(ALL);
  $('#btnExportXLSX').onclick = ()=> exportXLSX(ALL);

  async function __app_boot(){
    if (!APP_CONFIG.API_BASE) return alert('⚠️ ضع API_BASE في config.json');
    if (!APP_CONFIG.API_KEY)  console.warn('ℹ️ يمكنك تمرير ?key=YOUR_API_KEY مرة واحدة وسيُخزن محليًا.');
    await reloadAll();
    $('#btnSearch').addEventListener('click', applyFilters);
    $('#btnReset').addEventListener('click', async ()=>{ $('#q').value=''; $('#fltTech').value=''; $('#fltStatus').value=''; $('#from').value=''; $('#to').value=''; await reloadAll(); });
  }
</script>
</body>
</html>
